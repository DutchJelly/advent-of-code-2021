let puzzleEnhancer = '#.#...######..#####...#.####.#####.#.#.#.#..###.#.###...#.#..#.#.#......#.##...#.#.###....#.####.#.####.#..###...#####..####.##..####..##.##.....#..##...#.#..###.###.##..###.##.##....#....#.##..###....#.#...#..#.#.#.##.#.####..#....#..######..#####.##.#.#.##.##...##.#.#..##.#######.#..##..#...#...###..####.....#.#.#.###..###.##.....#####.#..##..####..#.##..#.#.....###.#.###.#.#....#.#.#..#.#..#.##..######.#.........##...##...##.#...##..##....###...##..##......#.#.#.###.##.#.#...#..##...#..........#...###...';
let puzzleInput = [
    '###.#.....###.#.....##.##..#.#..#.##....#..#..#.##..#..#.###.....#.##...#.#.####.##....##.#..#...#..',
    '#..#...######.#....#.#.#.#.##.#..#####.###.####....#.##..##...#..###..##.##.#.#.##.#.#.#.#...#......',
    '..#..##.#.##.#..#...##.######.###...#..####..#.#.#.##.##.#...####....####.#.#..#.#.##..###..##..##.#',
    '.##..##..#.#...####.#..#.###....##.####....##.#.#..#...##.#.....####.#.#.#.#####..#..####.#.#...#..#',
    '..#.#.##..######.##.#..##..####.#.##.....#..###..#......######......##..##.#...#.##..#..#.##..#.###.',
    '..###..#####...####.#.#....#####....#..#.##.##.#..#########..##..#.#.#..#..#..#..#.###.#.....######.',
    '#...#......#.##.#.#...##...####...#.##...#........###...##.....#.##..#######.###.##....#..##.#..####',
    '##..#......#..#..##..####.##.#....###..#.####.#.####...###.###.##....#.#.###.#.#...###.#.....#.#...#',
    '.#.###.##.......#.#..###......##.####.##.......##..##..##.....##.......###.#.#..##..#.#####.#.#.#.#.',
    '#..##.#.......###..###..#..#.#.#..##...#.##.......#.#.#...###.#...#.#.#.#..###.#.#..#..####...###...',
    '..#.##.#...##.#.#.##...####.#.#.###...#..##..###....#.#..#.#.###...#..###.#.##.###......#.#.#.#.###.',
    '..###.#.###.#.#########...###...#.###.#..##..#######..###.#.#####.####...#.###...#.##..###.#.##....#',
    '..#....#..#.###.##..###....#.##.###.##.........##.#..####.##.###..###.##.####.####..##..##...##.#...',
    '..###..#...#...#.###.#..##.....#.#.##..####...##.#######.##.#.##...#.###......#.#..#.###.####.##..#.',
    '###..#.#.#.......####.#...#.#.#.###...#.###.###..#......##..#......#.#.##.###..#...#.##...#..#..####',
    '..###....#..##.##...#.#.#..#.##.####.##.#..#######.##.#...#.###.#..#.########.#.##.#.##.#...#..###..',
    '...#.#.#.#.....###...#..#.#....#####........###........#.#..#.#.#...####.##.#..##..###.#########...#',
    '..#...##..###.#.#.#.##....#..##..##.....#.##..#.##.#..#.........##.##..######.#.#..#...#....###...##',
    '#.##..##.##.##.###...#.#..#.#.##...##...##..#..#....#.###..####..##.#....###.......#.###...#.....##.',
    '#.#..###..#..##...#.#.########.##.#.###.############.##....#..####.###...#...#..#.###.#..#...#..#...',
    '.#..#.##.##.#..##..#...#######.##.#...#.#.#..#.#.#.#....##.####.###..##.#.#..#.#......###.#..#####.#',
    '.#....#.##.###..#....#..#..##......#.#.#..#.##..##...#.#.#.##...##.#..#.###....#...#.###..#.####..##',
    '.###....#..#.###.#.#.#....######....#.###.####..####.######.##..###..#...##..#.##.#..######.#.#...#.',
    '.#.#....####..#...###..###.##..#####.#...#.#.#.#.#..###..#..###..#.##.#.#.#.##...#.##.####.#..#.#...',
    '#....#...##.#...####...##.#....#.#...#..######.###...#.##.####.##....##.#.####.###....#.##.##.####.#',
    '.#.#####..##.....##.#..#.#..#..#####.....##....####.#####..#.#....#..###.##...#...###.#........##...',
    '###.####.#.##...#####.#.#####...#.####..#....####..###.###..#.#...####.#....#..##...##.##..##.#####.',
    '..##.##..#..#.##..#.##.#...#......##.#.##....##...#########.##...####.######.#.#.###.###.##.#.##..#.',
    '...#.#####..#.#..#.#.#.####.###....#.#.####.###.......###.##.#.....#############.###..####..#.##.#..',
    '...########.#..#..##.##..#.##.#..#...#.#####..###....#..#......#..##....#.#...#...#..##.####.##.#.#.',
    '#.####.#.#..#...###.###....#..##...#....##..#..#.#####.#..####...#...#...#.#.####.#.###....#.#.....#',
    '#..##.##.#..#####...##..#.....#..#.#.....####........####..##.##...##..#####...#..#.##...#..#....#.#',
    '...##.###..#.###..###.#####..##.#.....##.##.#....##.#.#.#........#.##.##.#.#..#.##.#..##...#..##..##',
    '##..#...###.#.#.####....#.#.##..#...#..###..#.###.#..#.##.....#..#..#########..#.##..##.##.#.....#..',
    '#..###...#...####..#..#.....##.#.#....###..#.###...######..##..#.##...#....#.##.###.#..##...#.#..#.#',
    '.#.....##.#.##.#.#####..#.#.##..###..##.##.##.#..######..######.##.#.###.#.#.##.#...##.#.#...####...',
    '###..#.#.####.#...####..#.#.#..###.#######.##.#...####.#####.##.#...#...#...#..##..#######.#.#.#.#..',
    '####.####..#####.#.#.....#...###..######.#..#.#.##.##.##..##...#..####....##..#.##...##..#.##.#...##',
    '##....#...#.###.###.###.......#.#.......#..##.##.#.#.#.####.......###.#.#....######.#.....##....#...',
    '#...#.######.##..#..##.##...#.##.##.##...#.#.####......#..##.##..#..#......###.#.##.#.#..##.##..#..#',
    '.....#.#...###...#.....##.#.#.#.###....#..#..#.##.###.#......#.......#.#.##..###.###.###..#.##.#.#.#',
    '..##..#.##.#####.#.##..#.###..#..##..##..##.##.#.#.#.#..#...#...####.##.##.#..#.#.#.##.#####....###.',
    '#.#..####.####..##.#...#.#.#.#.###...#####.....##...###..#####.#.#..####.#...#.###.##..###..##...#..',
    '###.####..#...#.#####...#...####.#.#....####.#.........#..###.#....######.######.###.#..#.....#..##.',
    '#.##..#...##.###.#..###.#.#..#.#.###...#####.#.#..###...#.##...#...###..##..##....#..##.####..#....#',
    '.#.##..####.########.##..#..##.#.#.####....###.#####...#.###..#...##..#.#####.#####...######.#.###..',
    '.#..#.###..#.#.#.....###.#..#..###...###.#.##.#.##..##.##..##.#.#.##....##.##.##.##..#.#....##..#..#',
    '.#.#.##.##..#..######.##...#######.#..#.#.#####.#..#....##.....##.##...####.......#.##.#.#.#..#####.',
    '#####...#.##.##.###.#.#.#.#.##.###.#...#.#...#......###.#.#.###..#.#....#.....#...#.#..#.#.#.##...#.',
    '##.#........#..#.###.#.#.#.......##..###.##...##....##.##..#.###..###...##...####.########.#..#####.',
    '##.#..#.###.#.#.#.##.##.###..###.##....######...####.#.#.#...####....####.###...##..#.#.#..#..#...#.',
    '##..#####.#####.#.##..###.#....####.#.#.#.#..##.#.####.###....####..#.##..#...##.##.#.#.####.##..#..',
    '...#..##..#####..##.##.##.#..#...#.#.###.....#...###.#....#.#.####...#..####....#...###.#....##..###',
    '##.#..#..#.#.####...#.#..##.###..###...#...#...#...#.#....##...#..##..####.....###.##...#..###..#...',
    '#...########.....###....###.####..##.##.#.##.##..#..##..##...##....##.#..#..##..#.##..#..##..##.###.',
    '..#..#.##.#..#...##.......#...#.##..#..####..##.##..##..#..##.###.#....#..#.#....#.###.###.......###',
    '###.##.##.######........##..#.#####...###....##..#.#####..##..##...#.###.#.###.###.######.##..#.##.#',
    '..#..##.....#.#.#...#...###.#..##...####...####.#.#..#####.##...##...#.#.#.###..#.#...#...####.##...',
    '.####..#..##......#.#.#....###......###.########.#..#.##...##..##.##..######.#.####...##.##.##..###.',
    '..#.#####..##.#..##....####.###..##.#.##.####..###..##.#.#.###...##..####.##.#.....#...####.#.#..###',
    '####....#.##....#.#.##...######.#.#...#.#...#.#..####.#..#.#..###...#.#....#####.###...#....####..#.',
    '..####...###..##..#..#..###..#.#...##.#.###...##....#.###..#...#####.#...##...####..#.#..#...##.###.',
    '#####.##....#.#.##....#.#.#.#.#....##...#.##.#.#.##...#.###.....####..#.#....#.#.#.######..#.##..#..',
    '####.#.##.##...###....##...##..#..#....##..#.#.#.#..#..###.......###.#.####..#.####.....#.#.##.#..##',
    '..#.#.###..###########.#...#..###.###.#....#...##....#.#.#..##....#..#.#.##...#.###.....##.#.#...#..',
    '.#..#.#..#.##...#####.##.....##.#.#.#..#.#.#....###.###.#..###.#....##..##..######......##.###.#..##',
    '#.###..##.##...##.##.....#.#.#..##.#...#.##...#..#.#...###..#.......##...##...###.#.....###..##.#.##',
    '..##.####..###.#.##..##.#....##.#####.#....#.#.#.#.##.##..#.#..#...###.#..#..#.....#....#..#.#...###',
    '#.##...######..###.#.#.#...##.####.###..#.##.##.###.#..#.#.###..#..##.#..#..#..##..##.#.#.#..#..#...',
    '##.##...###.##.#.#.......#..##..#..###..#...#.#..##########..#......#...#.##..#..##.###...###.######',
    '#.#..#.###......#...###.###..#.........#.##.#.##.###....#.######..##..#.###.......#..##...###......#',
    '....##.#.......##.#.#.###.###.####.#.#..##.#..##.#...####.#..#...#...#..##.###.#.#.####..##......##.',
    '.#...######..##.##...#.####..#...#.....##.#####.##....###....#......#.#.##..#.#......#.#.#..###..##.',
    '#.##..##...#####.#.####..#..##.###.####.#.#.###.##..####..###.####..#..##.#.###.....#####.##..#..###',
    '.###.###.#.##..#...##.#..#.#..#######...#....#.#.....#..#.#....###.#..###....#.#.#.####....#.#.##..#',
    '####..###..#....##....#.#.....#.##.#.##..##.###..#....##..######.##.##.#.#...##..###.###.#######.###',
    '##.#.##..#########.#.##.###.#...#######.###.#.#.#######.##...#.#..##.#.##..##.#.#....####.#..######.',
    '....#..#.####.#........#.#.#.#.##.....###.####..##....#.###...#...####.....###...#.###...###.##.####',
    '#.....#..##..##.######.#...######..#.....#..##..#..###.#.###.###.#.##.....##.###..#......##......###',
    '.#..#.......#..#...#...##.####..##...#.#.#.................#.##...##..##.#..##....#.....#...##..#.#.',
    '#...###......#......#.######.#####..#....##..##....#.#..##.##.#....###.#.....###.#.#.#.......##.#...',
    '#######.##..#.#.##.##...#...##..#.##.##.###..##.####.###.#.##.#..#.########.....######......#.#.#.##',
    '#...##..#.#.........##.#...#...#..###.####.####.#.##.#..#.#..##..##.##.#..##..##...#...###.##.#.....',
    '#.##.##....#....##.##...#####.....#.###...####.##.##..#.#.##.############...#..########.###..#.####.',
    '##..#..#.###....##.###.##..#.#..#.##..#..#.#####.#....####.#..##...#########.###...#.#..#..##.#.###.',
    '..#..........##...###......#..#.#..#.##.#####.....###.#.##....#..###.#.##.##..#.##.#.....#.#.#...##.',
    '..#.#..#...#####.#.#.#.##.#..#.#.#####..##.......#.#..#.########..##.#..#.#..#...######...##...#..#.',
    '..#..#......#..###..#...#....#.#.#..####...###.#..#.........#.#.######.#.##.#.#..##..#.####......#..',
    '##.#.###.#...#.###..#.######.#...####.#.#####..#.#.##.....#..##.##.##...#####.....####.#.########..#',
    '..###.###.##..####..#.....#.#..#...######.#.##.##..#.##.......#.##.###....##.##.####....####...#.#..',
    '###.#.#.##.....#.######.#...#####.##.#..##..#.#.....##....####..#..#.##.#.#.##.###.#..###.###.#.....',
    '..##.#.#.#.#...###.####.#.##.#..#.#.#..#..#..#######.####..#.#...##....#..#....###...##..####....###',
    '..#..#..##.#####.#.....#...#.##......#...##...##..##.##.....##.#....##.#.#.#.#.#.#...##.#.#..###.#.#',
    '.##.#.#....#..#..##.#.#..##.###.##.#######..####.##.####..#.#.#.....#.#..##...##..##.##.####...#.##.',
    '#......##.....#.#..#..##.###.##.#..###.##..#.....#...##.##.##.#.##..#.###.#..#..#.#.......##...#...#',
    '#.#.###..#.#####.......#....#....#...#..#.......#.####.#..#.....#....##..#####.##....##..##.##......',
    '###...#.#....###.###...#..#.#.#....##..##.#..###.#..##...#..#..#.#.....#.####.#.##......##..#.####..',
    '####.##...###.....##.##.....#.#.#....#.###.######.......#.###.#.........###.#...##.###..##..#.#..##.',
    '.#..##.##.##...###.#.#..##...#.###...###.#...#....#...###....#...#.#..#.#.#.#....#.....####...#....#',
    '.#.####.##.##..#...##.#.#.#...##.##.#######.#.##...#.#.#...##....#####.#..#.#..#...####.##.##...###.'
]

let testInput = [
    '#..#.',
    '#....',
    '##..#',
    '..#..',
    '..###',
]

let testEnhancer = '..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#'

let input = puzzleInput.map(x => [...x]);
let enhancer = puzzleEnhancer;

let allBlack = false;

const padding = 1;

const getPixel = (i, j) => {
    if (i < 0 || i >= input.length || j < 0 || j >= input[0].length)
        return allBlack ? '#' : '.';
    return input[i][j];
}

const enhance = (level) => {
    for (let c = 0; c < level; c++) {

        let newImage = [];
        for (let i = 0; i < input.length + padding * 2; i++) {
            newImage[i] = Array(input[0].length + padding * 2).fill(allBlack ? '#' : '.');
        }

        for (let i = -padding; i < input.length + padding; i++) {
            for (let j = -padding; j < input[0].length + padding; j++) {
                let pixels = '';
                for (let offI = -1; offI <= 1; offI++) {
                    for (let offJ = -1; offJ <= 1; offJ++) {
                        pixels += getPixel(i + offI, j + offJ);
                    }
                }

                const enhanceIndex = parseInt(pixels.replaceAll('.', '0').replaceAll('#', '1'), 2);
                newImage[i + padding][j + padding] = enhancer[enhanceIndex];
            }
        }
        input = newImage;
        if (!allBlack && enhancer[0] === '#') allBlack = true;
        else if (allBlack && enhancer[2 ** 9 - 1] === '.') allBlack = false;
    }
}


enhance(2);
console.log(input.map((x, i) => ("000" + i).slice(-3) + ' ' + x.join('')).join('\n'))
console.log(`[part one] count black pixels: ${input.reduce((p, c) => p + c.reduce((pp, cc) => cc === '#' ? pp + 1 : pp, 0), 0)}`);
enhance(48);
console.log(`[part two] count black pixels: ${input.reduce((p, c) => p + c.reduce((pp, cc) => cc === '#' ? pp + 1 : pp, 0), 0)}`);

